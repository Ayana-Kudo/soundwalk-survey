<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚µã‚¦ãƒ³ãƒ‰ã‚¦ã‚©ãƒ¼ã‚¯ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 16px;
      background: #f7f7f7;
    }
    h1, h2, h3 {
      text-align: center;
    }
    .screen, .surveyPage {
      display: none;
    }
    input, textarea, button, select {
      width: 100%;
      font-size: 1rem;
      padding: 10px;
      margin-top: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #1976d2;
      color: white;
      font-weight: bold;
      border: none;
      margin-top: 20px;
    }
    button:hover {
      background: #1565c0;
    }
    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
    }
    #video, #previewImage {
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      display: block;
    }
    #progressContainer {
      width: 100%;
      height: 10px;
      background: #ddd;
      margin: 20px 0;
    }
    #progressBar {
      height: 100%;
      background: #4caf50;
      width: 0%;
      transition: width 0.4s;
    }
    small {
      color: gray;
      display: block;
      margin-top: 4px;
    }
  </style>
</head>

<body>

<!-- ğŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
<div id="startScreen" class="screen" style="display: block;">
  <h1>ã‚µã‚¦ãƒ³ãƒ‰ã‚¦ã‚©ãƒ¼ã‚¯</h1>
  <button onclick="goToInput()">å§‹ã‚ã‚‹</button>
</div>

<!-- ğŸ“ å…¥åŠ›ç”»é¢ -->
<div id="inputScreen" class="screen">
  <h2>åå‰ãƒ»æ€§åˆ¥ãƒ»å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
   <input type="text" id="name" placeholder="åå‰"><br>
   <select id="gender">
     <option value="">æ€§åˆ¥ã‚’é¸ã‚“ã§ãã ã•ã„</option>
     <option value="ç”·æ€§">ç”·æ€§</option>
     <option value="å¥³æ€§">å¥³æ€§</option>
   </select><br>
   <input type="number" id="age" placeholder="å¹´é½¢"><br>
   <button onclick="requestPermissions()">æ¬¡ã¸</button>
</div>

<!-- ğŸ“· æ’®å½±ç”»é¢ -->
<div id="cameraScreen" class="screen">
  <h2>æ’®å½±ã—ã¦ãã ã•ã„</h2>
  <video id="video" autoplay playsinline></video><br>
  <canvas id="canvas" style="display:none;"></canvas><br>
  <button onclick="capture()">æ’®å½±</button>
</div>

<!-- ğŸ–¼ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ -->
<div id="previewScreen" class="screen">
  <h2>ã“ã®ç”»åƒã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ</h2>
  <img id="previewImage" src=""><br>
  <button onclick="goToSurvey()">ä½¿ç”¨ã™ã‚‹</button>
  <button onclick="retake()">å†æ’®å½±</button>
</div>

<!-- ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ -->
<div id="surveyScreen" class="screen">
  <h2>éŸ³ã«é–¢ã™ã‚‹ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
  <div id="progressContainer"><div id="progressBar"></div></div>

  <!-- Q1 -->
  <div id="q1Page" class="surveyPage">
    <h3>Q1. æ°—ã«ãªã£ãŸéŸ³ã¯ä½•ã®éŸ³ã§ã™ã‹ï¼Ÿ</h3>
    <small style="color: gray;">ä¾‹ï¼šè»Šã®éŸ³ï¼ãŠåº—ã®ã‚¬ãƒ¤ã‚¬ãƒ¤ã—ãŸéŸ³ ãªã©</small><br>
    <input type="text" id="q1Input" name="q1" placeholder="è‡ªç”±ã«ã”è¨˜å…¥ãã ã•ã„"><br><br>
    <button onclick="nextSurveyPage()">æ¬¡ã¸</button>
  </div>

  <!-- Q2 -->
  <div id="q2Page" class="surveyPage">
    <h3>Q2. ãã®éŸ³ã«å¯¾ã™ã‚‹è©•ä¾¡ã¯ä½•ã§ã™ã‹ï¼Ÿ(é¸æŠå¼)</h3>
    <small style="color: gray;">ä¾‹ï¼šãƒ»ã‚„ã‚„æ‚ªã„ </small><br><br>

ã€€ã€€<label><input type="radio" name="q2" value="ã¨ã¦ã‚‚è‰¯ã„"> ã¨ã¦ã‚‚è‰¯ã„</label><br>
    <label><input type="radio" name="q2" value="ã‚„ã‚„è‰¯ã„"> ã‚„ã‚„è‰¯ã„</label><br>
    <label><input type="radio" name="q2" value="ã©ã¡ã‚‰ã§ã‚‚ãªã„"> ã©ã¡ã‚‰ã§ã‚‚ãªã„</label><br>
ã€€ã€€<label><input type="radio" name="q2" value="ã‚„ã‚„æ‚ªã„"> ã‚„ã‚„æ‚ªã„</label><br>
ã€€ã€€<label><input type="radio" name="q2" value="ã¨ã¦ã‚‚æ‚ªã„"> ã¨ã¦ã‚‚æ‚ªã„</label><br>
    <button onclick="prevSurveyPage()">æˆ»ã‚‹</button>
    <button onclick="nextSurveyPage()">æ¬¡ã¸</button>
  </div>

  <!-- Q3 -->
  <div id="q3Page" class="surveyPage">
    <h3 id="q3Template" style="text-align: left;">
      Q3. <span id="q3DynamicText">(Q1) ãŒ (Q2) ã¨è©•ä¾¡ã—ãŸã®ã¯ã©ã†ã„ã†ç†ç”±ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿï¼ˆè¤‡æ•°å›ç­”å¯ï¼‰</span>
    </h3>

    <p style="color: gray; margin-top: -8px;">
    ä¾‹ï¼šã€ŒéŸ³ãŒã†ã‚‹ã•ã‹ã£ãŸã‹ã‚‰ã€ã€Œäººã€…ãŒã«ãã‚„ã‹ã§æ¥½ã—ãã†ã ã£ãŸã‹ã‚‰ã€ãªã©
  </p>

    <div id="q3-container">
    <!-- æœ€åˆã®1ã¤ç›®ã®å…¥åŠ›æ¬„ -->
    <div class="q3-input-set">
      <label>1.</label>
      <input type="text" name="q3[]" placeholder="ç†ç”±1">
    </div>
  </div>

  <button type="button" onclick="addQ3Input()">ï¼‹ ç†ç”±ã‚’è¿½åŠ </button><br><br>

  <button onclick="prevSurveyPage()">æˆ»ã‚‹</button>
  <button onclick="nextSurveyPage()">æ¬¡ã¸</button>
  </div>
  
 <!-- Q4 -->
  <div id="q4Page" class="surveyPage" style="display: none;">
     <h3 id="q4Template" style="text-align: left;">
       Q4. <span id="q4DynamicText">Q3ã‚’ãµã¾ãˆã¦ä»¥ä¸‹ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„</span>
    </h3>

    <p style="color: gray; margin-top: -8px;">
    ä¾‹ï¼šã€Œä¸å¿«ã«æ„Ÿã˜ã‚‹ã€ã€Œè‡ªåˆ†ã‚‚ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã€ãªã©
  </p>

    <div id="q4-container"></div>

  <button onclick="prevSurveyPage()">æˆ»ã‚‹</button>
  <button onclick="completeSurvey()">é€ä¿¡ã™ã‚‹</button>
  </div>

</div>

<!-- âœ… å®Œäº†ç”»é¢ -->
<div id="doneScreen" class="screen">
  <h2>å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h2>
  <p>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</p>
  <button onclick="location.reload()">æœ€åˆã«æˆ»ã‚‹</button>
</div>

<script>
let latitude = null, longitude = null, weather = "ä¸æ˜";
let currentSurvey = 1;
const totalSurvey = 4;

function goToInput() {
   console.log("goToInput() ãŒå‘¼ã°ã‚ŒãŸã‚ˆ");
  switchScreen("inputScreen");
}

function requestPermissions() {
  const name = document.getElementById("name").value.trim();
  const gender = document.getElementById("gender").value;
  const age = document.getElementById("age").value.trim();

  if (!name || !gender || !age) {
    alert("åå‰ãƒ»æ€§åˆ¥ãƒ»å¹´é½¢ã™ã¹ã¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    document.getElementById("video").srcObject = stream;
    switchScreen("cameraScreen");
  }).catch(() => {
    alert("ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“");
  });

  navigator.geolocation.getCurrentPosition(pos => {
    latitude = pos.coords.latitude;
    longitude = pos.coords.longitude;
    getWeather();
  });

  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    document.getElementById("video").srcObject = stream;
    switchScreen("cameraScreen");
  }).catch(() => {
    alert("ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“");
  });
}

function getWeather() {
  const apiKey = "ddf228dc78adbc76e8419917bc2ce4cd"; // â˜…å¤©æ°—å–å¾—ã«ã¯ã‚­ãƒ¼ãŒå¿…è¦
  fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric&lang=ja`)
    .then(res => res.json())
    .then(data => {
      weather = `${data.weather[0].description}ï¼ˆ${data.main.temp}â„ƒï¼‰`;
    });
}

function switchScreen(id) {
  document.querySelectorAll(".screen").forEach(el => el.style.display = "none");
  document.getElementById(id).style.display = "block";
}

function capture() {
  const name = document.getElementById("name").value.trim();
  const gender = document.getElementById("gender").value;
  const age = document.getElementById("age").value.trim();

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  ctx.fillStyle = "white";
  ctx.font = "20px sans-serif";
  ctx.fillText(`${name} / ${gender} / ${age}æ­³`, 10, 30);
  ctx.fillText(weather, 10, 60);

  document.getElementById("previewImage").src = canvas.toDataURL("image/png");
  switchScreen("previewScreen");
}

function retake() {
  switchScreen("cameraScreen");
}

function goToSurvey() {
  switchScreen("surveyScreen");
  showSurveyPage(1);
}

function showSurveyPage(id) {
  document.querySelectorAll(".surveyPage").forEach(p => p.style.display = "none");
  const el = document.getElementById(`q${id}Page`);
  if (el) el.style.display = "block";

  currentSurvey = id;
  document.getElementById("progressBar").style.width = `${(id / totalSurvey) * 100}%`;

  if (id === 3) {
    const q1 = document.getElementById("q1").value.trim();
    const q2 = document.querySelector('input[name="q2"]:checked')?.value || "";
    document.getElementById("q3Template").innerText = `Q3.ã€Œ${q1}ã€ãŒã€Œ${q2}ã€ã¨è©•ä¾¡ã—ãŸã®ã¯ã©ã®ã‚ˆã†ãªç†ç”±ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ(è¤‡æ•°å›ç­”å¯)`;
  }

ã€€if (id === 4) {
  ã€€const q2 = document.querySelector('input[name="q2"]:checked')?.value || "";
 ã€€ const q3 = document.getElementById("q3").value.trim();
  ã€€document.getElementById("q4Template").innerText = `Q4. Q3ã‚’ãµã¾ãˆã¦ä»¥ä¸‹ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„`;
ã€€}

}

function nextSurveyPage() {
  const current = document.querySelector(".surveyPage:not([style*='display: none'])");
  const next = current.nextElementSibling;

  if (next && next.classList.contains("surveyPage")) {
  next.style.display = "block";
  currentSurvey++; // â† ã“ã‚Œã‚’è¿½åŠ ï¼
  document.getElementById("progressBar").style.width = `${(currentSurvey / totalSurvey) * 100}%`;
}

  // ğŸ” Q2 â†’ Q3 ã«é€²ã‚€ã¨ãï¼šQ3ã®è³ªå•æ–‡ã‚’å‹•çš„ã«æ›´æ–°ï¼
  if (current.id === "q2Page") {
    updateQ3Heading();
  }

  // ğŸ” Q3 â†’ Q4 ã«é€²ã‚€ã¨ãï¼šQ3ã®å…¥åŠ›ã‹ã‚‰Q4ã®è¨­å•ã‚’ç”Ÿæˆï¼
  if (current.id === "q3Page") {
   generateQ4FieldsFromQ3();
   updateQ4Heading();
  }

  current.style.display = "none";
  if (next && next.classList.contains("surveyPage")) {
    next.style.display = "block";
  }
}

function prevSurveyPage() {
  if (currentSurvey > 1) {
    showSurveyPage(currentSurvey - 1);
  }
}

function updateQ3Heading() {
  const q1 = document.getElementById("q1Input").value.trim();
  const q2 = document.querySelector('input[name="q2"]:checked')?.value || "";
  const span = document.getElementById("q3DynamicText");

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å…¼ã­ã¦è‡ªç„¶ãªè¡¨ç¾ã«ã™ã‚‹
  span.textContent = `ã€Œ${q1 || "ã“ã®éŸ³"} ã€ãŒ ã€Œ${q2 || "ã“ã®è©•ä¾¡"} ã€ã¨è©•ä¾¡ã—ãŸã®ã¯ã©ã†ã„ã†ç†ç”±ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿï¼ˆè¤‡æ•°å›ç­”å¯ï¼‰`;
}

function updateQ4Heading() {
  const q1 = document.getElementById("q1Input").value.trim();
  const dynamic = document.getElementById("q4DynamicText");
  dynamic.textContent = `Q3ã‚’ãµã¾ãˆã¦ã€Œ${q1 || "ã“ã®éŸ³"}ã€ã«ã¤ã„ã¦ä»¥ä¸‹ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„`;
}

function generateQ4FieldsFromQ3() {
  const q1 = document.getElementById("q1Input").value.trim() || "ã“ã®éŸ³";
  const q3Inputs = Array.from(document.querySelectorAll('input[name="q3[]"]'))
    .map(input => input.value.trim())
    .filter(val => val !== "");
  const q3 = q3Inputs.join("\n");

  const q4Container = document.getElementById("q4-container");
  q4Container.innerHTML = ""; // åˆæœŸåŒ–

  q3Inputs.forEach((reason, idx) => {
    const div = document.createElement("div");
    div.className = "q4-input-set";
    div.innerHTML = `
      <label><strong>${idx + 1}.ã€Œ${q1}ã€ãŒã€Œ${reason}ã€ã ã¨ã©ã†ã„ã†æ°—æŒã¡ã«ãªã‚Šã¾ã™ã‹ï¼ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ</strong></label><br>
      <textarea name="q4[]" rows="3" placeholder="è‡ªç”±ã«ã”è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea><br><br>
    `;
    q4Container.appendChild(div);
  });
}

function completeSurvey() {
  const name = document.getElementById("name").value.trim();
  const gender = document.getElementById("gender").value;
  const age = document.getElementById("age").value.trim();
  const q1 = document.getElementById("q1Input").value.trim();
  const q2 = document.querySelector('input[name="q2"]:checked')?.value || "";
  const q3Inputs = Array.from(document.querySelectorAll('input[name="q3[]"]'))
  .map(input => input.value.trim())
  .filter(val => val !== "");
  const q3 = q3Inputs.join("\n");
const q4Inputs = Array.from(document.querySelectorAll('textarea[name="q4[]"]'))
  .map(el => el.value.trim())
  .filter(val => val !== "");
  const q4 = q4Inputs.join("\n");
  const imageData = document.getElementById("canvas").toDataURL("image/png");

  // ä¿å­˜ï¼šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå†…å®¹
  const text = `åå‰ï¼š${document.getElementById("name").value}\næ€§åˆ¥ï¼š${gender}\nå¹´é½¢ï¼š${age}\nç·¯åº¦çµŒåº¦ï¼š${latitude}, ${longitude}\nå¤©æ°—ï¼š${weather}\n\nQ1ï¼š${q1}\nQ2ï¼š${q2}\nQ3ï¼š${q3}\nQ4ï¼š${q4}`;//
  const blob = new Blob([text], {type: "text/plain"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `å›ç­”_${Date.now()}.txt`;
  link.click();

  // ä¿å­˜ï¼šç”»åƒ
  const a = document.createElement("a");
  a.href = imageData;
  a.download = `ç”»åƒ_${Date.now()}.png`;
  a.click();

  // ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰é€ä¿¡å‡¦ç†
  fetch("https://csv-upload-api-vcnd.onrender.com/submit", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: new URLSearchParams({
      name: document.getElementById("name").value,
      gender: gender,
      age: age,
      lat: latitude,
      lon: longitude,
      weather: weather,
      image: imageData,
      q1: q1, q2: q2, q3: q3, q4: q4
    })
  }).then(res => res.text())
    .then(msg => console.log("é€ä¿¡æˆåŠŸ:", msg))
    .catch(err => alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err))
    .finally(() => switchScreen("doneScreen"));
}
</script>

<script>
  let q3Index = 1;

  function addQ3Input() {
    q3Index++;
    const container = document.getElementById("q3-container");
    const div = document.createElement("div");
    div.className = "q3-input-set";
    div.innerHTML = `
      <label>${q3Index}.</label>
      <input type="text" name="q3[]" placeholder="ç†ç”±${q3Index}">
    `;
    container.appendChild(div);
  }
</script>

</body>
</html>
